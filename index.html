<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional Pallet Builder</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
    body { font-family: 'Segoe UI', system-ui; background:#f0f2f5; padding:20px; color: #333; }
    .toolbar { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; align-items:center; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .card { background:#fff; border-radius:10px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:15px; position: relative; }
    .pallet-card { border-left:5px solid #2563eb; }
    .pallet-header { font-weight:700; margin-bottom:10px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .row { display:grid; grid-template-columns:40px 1fr 100px 60px; font-size:14px; padding:5px 0; border-bottom: 1px dashed #fafafa; }
    .row:last-child { border: none; }
    .highlight { background:#fef3c7; border-radius: 4px; font-weight: bold; }
    input, button { padding:10px; border-radius:8px; border:1px solid #d1d5db; outline: none; }
    button { cursor:pointer; background:#2563eb; color:#fff; border:none; transition: 0.2s; }
    button:hover { background: #1d4ed8; }
    button.secondary { background:#4b5563; }
    button.danger { background:#ef4444; padding: 4px 8px; font-size: 12px; }
    #progress-container { width: 200px; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; display: none; margin: 0 10px; }
    #progress-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }
    #lastSizeDisplay { margin:15px 0; padding:20px; font-size:24px; background:#fff; border-radius:10px; font-weight:700; text-align:center; color:#2563eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    #message { position: fixed; top: 20px; right: 20px; padding:12px 24px; border-radius:8px; background:#333; color:#fff; display:none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .stat-label { font-size: 12px; color: #6b7280; margin-bottom: 2px; }
</style>
</head>
<body>

<div class="toolbar">
    <button onclick="uploadBase.click()">Upload Base Info</button>
    <input type="file" id="uploadBase" hidden accept=".xlsx, .xls" />
    
    <button class="secondary" onclick="uploadResume.click()">Resume Work</button>
    <input type="file" id="uploadResume" hidden accept=".xlsx, .xls" />

    <div id="progress-container"><div id="progress-bar"></div></div>
    
    <span id="fileName" style="font-weight:600; color:#667;">No File</span>
    <span id="progressText" style="margin-left:auto; font-weight:bold; color:#2563eb;">Progress: 0 / 0</span>
</div>

<div class="toolbar">
    <input id="boxInput" placeholder="Scan Box ID here..." style="flex:1; font-size: 16px;" />
    <input id="searchInput" placeholder="Search Scanned Box..." style="width:180px" />
    <div style="display:flex; align-items:center; gap:5px;">
        <span class="stat-label">Pallet Size:</span>
        <input id="palletSizeLimit" type="number" value="25" min="1" style="width:60px"/>
    </div>
    <button id="completeBtn" style="background:#10b981;">Complete Pallet</button>
    <button class="secondary" onclick="exportAndReset()">Export & Reset</button>
</div>

<div id="message"></div>
<div id="lastSizeDisplay">Waiting for Scan...</div>
<div id="palletArea"></div>

<script>
let boxSizeMap = JSON.parse(localStorage.getItem("boxSizeMap")||"{}");
let pallets = JSON.parse(localStorage.getItem("pallets")||"[]");
let currentPallet = JSON.parse(localStorage.getItem("currentPallet")||"[]");
let palletIndex = parseInt(localStorage.getItem("palletIndex")||"1");
let currentFileName = localStorage.getItem("currentFileName")||"";

const baseUploadInput = document.getElementById("uploadBase");
const resumeUploadInput = document.getElementById("uploadResume");
const boxInput = document.getElementById("boxInput");
const lastSizeDisplay = document.getElementById("lastSizeDisplay");

function init() {
    document.getElementById("fileName").textContent = currentFileName || "Waiting for Import";
    render();
    boxInput.focus();
}

function showMessage(msg, type="info") {
    const m = document.getElementById("message");
    m.textContent = msg;
    m.style.background = type === "error" ? "#ef4444" : "#333";
    m.style.display = "block";
    clearTimeout(m.timeout);
    m.timeout = setTimeout(() => m.style.display = "none", 3000);
}

function save() {
    localStorage.setItem("boxSizeMap", JSON.stringify(boxSizeMap));
    localStorage.setItem("pallets", JSON.stringify(pallets));
    localStorage.setItem("currentPallet", JSON.stringify(currentPallet));
    localStorage.setItem("palletIndex", palletIndex);
    localStorage.setItem("currentFileName", currentFileName);
}

// 1. Upload Base Data
baseUploadInput.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    const pContainer = document.getElementById("progress-container");
    const pBar = document.getElementById("progress-bar");
    
    reader.onloadstart = () => { pContainer.style.display = "block"; pBar.style.width = "0%"; };
    reader.onprogress = ev => { if(ev.lengthComputable) pBar.style.width = (ev.loaded/ev.total*100) + "%"; };
    
    reader.onload = ev => {
        try {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            boxSizeMap = {};
            sheet.forEach(row => { if(row["箱号"]) boxSizeMap[row["箱号"]] = row["SIZE"] || "N/A"; });
            
            currentFileName = file.name;
            document.getElementById("fileName").textContent = currentFileName;
            showMessage("Base data loaded successfully!");
            save();
            render();
        } catch(err) {
            showMessage("Invalid file format", "error");
        } finally {
            pContainer.style.display = "none";
        }
    };
    reader.readAsArrayBuffer(file);
};

// 2. Resume Work (Import from Result Table)
resumeUploadInput.onchange = e => {
    const file = e.target.files[0];
    if(!file || Object.keys(boxSizeMap).length === 0) {
        showMessage("Please upload Base Info first!", "error");
        return;
    }

    const reader = new FileReader();
    reader.onload = ev => {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        const importedPallets = {};
        sheet.forEach(row => {
            const b = row["Box #"];
            const p = row["Pallet #"];
            if(b && p) {
                if(!importedPallets[p]) importedPallets[p] = [];
                importedPallets[p].push(b);
            }
        });

        pallets = Object.keys(importedPallets).map(k => ({
            pallet: parseInt(k),
            boxes: importedPallets[k]
        })).sort((a,b) => a.pallet - b.pallet);

        palletIndex = pallets.length > 0 ? Math.max(...pallets.map(p=>p.pallet)) + 1 : 1;
        save();
        render();
        showMessage(`Successfully restored ${pallets.length} pallets`);
    };
    reader.readAsArrayBuffer(file);
};

// Scan Logic
boxInput.onkeypress = e => {
    if(e.key !== "Enter") return;
    const val = boxInput.value.trim();
    boxInput.value = "";
    if(!val) return;

    if(!boxSizeMap[val]) return showMessage("Error: Box ID not in database!", "error");
    if(currentPallet.includes(val)) return showMessage("Warning: Already in current pallet!", "error");
    if(pallets.some(p => p.boxes.includes(val))) return showMessage("Warning: Already in a historical pallet!", "error");

    const limit = parseInt(document.getElementById("palletSizeLimit").value);
    if(currentPallet.length >= limit) return showMessage("Notice: Pallet is full, please complete it first", "error");

    currentPallet.push(val);
    lastSizeDisplay.textContent = `Current Size: ${boxSizeMap[val]}`;
    save();
    render();
};

// Complete Pallet
document.getElementById("completeBtn").onclick = () => {
    const limit = parseInt(document.getElementById("palletSizeLimit").value);
    if(currentPallet.length === 0) return;
    
    if(currentPallet.length < limit) {
        if(!confirm(`Current pallet only has ${currentPallet.length} boxes (limit is ${limit}). Complete anyway?`)) return;
    }

    pallets.unshift({ pallet: palletIndex++, boxes: [...currentPallet] });
    currentPallet = [];
    lastSizeDisplay.textContent = "Waiting for next scan...";
    save();
    render();
    showMessage("Pallet completed successfully");
    boxInput.focus();
};

// Delete single item
function removeBox(idx, isCurrent) {
    if(isCurrent) {
        currentPallet.splice(idx, 1);
    } else {
        if(confirm("Are you sure you want to delete this box from a completed pallet?")) {
            // Note: History delete currently re-renders local state
            render(); 
        }
    }
    save();
    render();
}

function render() {
    const area = document.getElementById("palletArea");
    const searchKey = document.getElementById("searchInput").value.trim();
    area.innerHTML = "";

    // Render Current
    if(currentPallet.length > 0) {
        let rows = currentPallet.map((b, i) => `
            <div class="row">
                <span>${i+1}</span>
                <span>${b}</span>
                <span>${boxSizeMap[b]}</span>
                <button class="danger" onclick="removeBox(${i}, true)">Del</button>
            </div>`).join("");
        area.innerHTML += `<div class="card">
            <div class="pallet-header"><span>Current Pallet (Scanning)</span> <span>${currentPallet.length} Boxes</span></div>
            ${rows}
        </div>`;
    }

    // Render History
    pallets.forEach(p => {
        let hasMatch = false;
        let rows = p.boxes.map((b, i) => {
            const active = searchKey && b.includes(searchKey);
            if(active) hasMatch = true;
            return `<div class="row ${active ? 'highlight' : ''}">
                <span>${i+1}</span>
                <span>${b}</span>
                <span>${boxSizeMap[b]}</span>
                <span></span>
            </div>`;
        }).join("");
        
        area.innerHTML += `<div class="card pallet-card" style="${searchKey && !hasMatch ? 'display:none' : ''}">
            <div class="pallet-header"><span>Pallet ${p.pallet}</span> <span>${p.boxes.length} Boxes</span></div>
            ${rows}
        </div>`;
    });

    const totalDone = pallets.reduce((s,p)=>s+p.boxes.length,0) + currentPallet.length;
    const totalTotal = Object.keys(boxSizeMap).length;
    document.getElementById("progressText").textContent = `Progress: ${totalDone} / ${totalTotal}`;
}

document.getElementById("searchInput").oninput = render;

function exportAndReset() {
    if(pallets.length === 0 && currentPallet.length === 0) return showMessage("No data to export");
    
    const allPalletsForExport = [...pallets];
    if(currentPallet.length > 0) {
        if(confirm("Current pallet is not completed. Export it as the last pallet?")) {
            allPalletsForExport.unshift({ pallet: palletIndex, boxes: [...currentPallet] });
        }
    }

    const data = [["Box #", "Pallet #", "SN"]];
    allPalletsForExport.sort((a,b)=>a.pallet-b.pallet).forEach(p => {
        p.boxes.forEach((b, i) => data.push([b, p.pallet, i+1]));
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Result");
    XLSX.writeFile(wb, `Pallet_Result_${new Date().getTime()}.xlsx`);

    if(confirm("Export finished. Reset all progress and start new job?")) {
        localStorage.clear();
        location.reload();
    }
}

init();
</script>
</body>
</html>